--[[
	Garrychet (aka. Ricochet 2)
	Made by: Nightmare
	Continued by: ptown2
	
	A gmod13 redo of the Ricochet game

TODO:
	- Setup multi-powerups IE get power disc and then get ice disc
]]

AddCSLuaFile("cl_init.lua")
AddCSLuaFile("cl_hud.lua")

AddCSLuaFile("shared.lua")
AddCSLuaFile("sh_global.lua")
AddCSLuaFile("sh_colors.lua")

AddCSLuaFile("obj_entity_extend.lua")
AddCSLuaFile("obj_player_extend.lua")
AddCSLuaFile("obj_weapon_extend.lua")
AddCSLuaFile("obj_server_extend.lua")

include("shared.lua")

include("obj_player_extend.lua")
include("obj_player_extend_sv.lua")
include("obj_entity_extend.lua")
include("obj_weapon_extend.lua")

GM:LoadGametypes()

function GM:AddResources()
--// File generated by F0x's Resources Generator 3.0.0 \\--
	resource.AddFile( "content/materials/editor/rs_envsun.vmt" )
	resource.AddFile( "content/materials/editor/rs_envsun.vtf" )
	resource.AddFile( "content/materials/editor/rs_smokestack.vmt" )
	resource.AddFile( "content/materials/editor/rs_smokestack.vtf" )
	resource.AddFile( "content/materials/floor/grid_blue_01.vmt" )
	resource.AddFile( "content/materials/floor/grid_blue_01.vtf" )
	resource.AddFile( "content/materials/floor/grid_blue_02.vmt" )
	resource.AddFile( "content/materials/floor/grid_blue_02.vtf" )
	resource.AddFile( "content/materials/floor/grid_blue_03.vmt" )
	resource.AddFile( "content/materials/floor/grid_blue_03.vtf" )
	resource.AddFile( "content/materials/models/arrow.vmt" )
	resource.AddFile( "content/materials/models/arrow.vtf" )
	resource.AddFile( "content/materials/models/arrow_normal.vtf" )
	resource.AddFile( "content/materials/models/bricks.vmt" )
	resource.AddFile( "content/materials/models/bricks.vtf" )
	resource.AddFile( "content/materials/models/deflector.vmt" )
	resource.AddFile( "content/materials/models/deflector.vtf" )
	resource.AddFile( "content/materials/models/deflector2.vmt" )
	resource.AddFile( "content/materials/models/deflector2.vtf" )
	resource.AddFile( "content/materials/models/deflector2_dudv.vtf" )
	resource.AddFile( "content/materials/models/deflector2_normal.vtf" )
	resource.AddFile( "content/materials/models/deflector_normal.vtf" )
	resource.AddFile( "content/materials/models/disc.vmt" )
	resource.AddFile( "content/materials/models/disc.vtf" )
	resource.AddFile( "content/materials/models/exhaust.vmt" )
	resource.AddFile( "content/materials/models/exhaust.vtf" )
	resource.AddFile( "content/materials/models/pipes.vmt" )
	resource.AddFile( "content/materials/models/pipes.vtf" )
	resource.AddFile( "content/materials/models/pipes_normal.vtf" )
	resource.AddFile( "content/materials/models/platform.vmt" )
	resource.AddFile( "content/materials/models/platform.vtf" )
	resource.AddFile( "content/materials/models/platformb.vmt" )
	resource.AddFile( "content/materials/models/platformb.vtf" )
	resource.AddFile( "content/materials/models/platformblue.vmt" )
	resource.AddFile( "content/materials/models/platformblue.vtf" )
	resource.AddFile( "content/materials/models/platformb_blue.vmt" )
	resource.AddFile( "content/materials/models/platformb_blue.vtf" )
	resource.AddFile( "content/materials/models/platformb_normal.vtf" )
	resource.AddFile( "content/materials/models/platformb_red.vmt" )
	resource.AddFile( "content/materials/models/platformb_red.vtf" )
	resource.AddFile( "content/materials/models/platformnorm_1.vtf" )
	resource.AddFile( "content/materials/models/platformnorm_2.vtf" )
	resource.AddFile( "content/materials/models/platformred.vmt" )
	resource.AddFile( "content/materials/models/platformred.vtf" )
	resource.AddFile( "content/materials/models/platform_a.vmt" )
	resource.AddFile( "content/materials/models/platform_a.vtf" )
	resource.AddFile( "content/materials/models/platform_a_normal.vtf" )
	resource.AddFile( "content/materials/models/platform_dif.vmt" )
	resource.AddFile( "content/materials/models/platform_dif.vtf" )
	resource.AddFile( "content/materials/models/platform_dif2.vmt" )
	resource.AddFile( "content/materials/models/platform_dif3.vmt" )
	resource.AddFile( "content/materials/models/poo/poo.vtf" )
	resource.AddFile( "content/materials/models/poo/poouv.vmt" )
	resource.AddFile( "content/materials/models/powerup.vmt" )
	resource.AddFile( "content/materials/models/powerup.vtf" )
	resource.AddFile( "content/materials/models/powerup_normal.vtf" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/atmosphere.vmt" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/atmosphere.vtf" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/cit_cloud001.vmt" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/cit_cloud001.vtf" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/cit_cloud002.vmt" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/cit_cloud002.vtf" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/cit_cloud003.vmt" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/cit_cloud003.vtf" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/cit_cloud003_dx7.vmt" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/cit_cloudlight.vmt" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/cloudglow1_nofog.vmt" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/cloudlightning/cit_cloudlight.vtf" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/cloud_funnel_01.vmt" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/cloud_funnel_01.vtf" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/planet.vmt" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/planet.vtf" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/rings.vmt" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/rings.vtf" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/vortexcenter.vtf" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/vortexspiral.vmt" )
	resource.AddFile( "content/materials/models/props_ricochet/skybox/vortexspiral.vtf" )
	resource.AddFile( "content/materials/models/pyramid.vmt" )
	resource.AddFile( "content/materials/models/pyramid.vtf" )
	resource.AddFile( "content/materials/models/pyramid_normal.vtf" )
	resource.AddFile( "content/materials/models/transporter.vmt" )
	resource.AddFile( "content/materials/models/transporter.vtf" )
	resource.AddFile( "content/materials/noxctf/sprite_bloodspray1.vmt" )
	resource.AddFile( "content/materials/noxctf/sprite_bloodspray2.vmt" )
	resource.AddFile( "content/materials/noxctf/sprite_bloodspray3.vmt" )
	resource.AddFile( "content/materials/noxctf/sprite_bloodspray4.vmt" )
	resource.AddFile( "content/materials/noxctf/sprite_bloodspray5.vmt" )
	resource.AddFile( "content/materials/noxctf/sprite_bloodspray6.vmt" )
	resource.AddFile( "content/materials/noxctf/sprite_bloodspray7.vmt" )
	resource.AddFile( "content/materials/noxctf/sprite_bloodspray8.vmt" )
	resource.AddFile( "content/materials/particle/exhaust.vmt" )
	resource.AddFile( "content/materials/ricochet/640_discblue.vmt" )
	resource.AddFile( "content/materials/ricochet/640_discblue.vtf" )
	resource.AddFile( "content/materials/ricochet/640_discblue2.vmt" )
	resource.AddFile( "content/materials/ricochet/640_discblue2.vtf" )
	resource.AddFile( "content/materials/ricochet/640_discgray.vmt" )
	resource.AddFile( "content/materials/ricochet/640_discgray.vtf" )
	resource.AddFile( "content/materials/ricochet/640_discred.vmt" )
	resource.AddFile( "content/materials/ricochet/640_discred.vtf" )
	resource.AddFile( "content/materials/ricochet/640_discred2.vmt" )
	resource.AddFile( "content/materials/ricochet/640_discred2.vtf" )
	resource.AddFile( "content/materials/ricochet/640_fast.vmt" )
	resource.AddFile( "content/materials/ricochet/640_fast.vtf" )
	resource.AddFile( "content/materials/ricochet/640_fire.vmt" )
	resource.AddFile( "content/materials/ricochet/640_fire.vtf" )
	resource.AddFile( "content/materials/ricochet/640_freeze.vmt" )
	resource.AddFile( "content/materials/ricochet/640_freeze.vtf" )
	resource.AddFile( "content/materials/ricochet/640_frozen.vmt" )
	resource.AddFile( "content/materials/ricochet/640_frozen.vtf" )
	resource.AddFile( "content/materials/ricochet/arrow.vmt" )
	resource.AddFile( "content/materials/ricochet/arrow.vtf" )
	resource.AddFile( "content/materials/ricochet/disc_blue1.vmt" )
	resource.AddFile( "content/materials/ricochet/disc_blue1.vtf" )
	resource.AddFile( "content/materials/ricochet/disc_dual1.vmt" )
	resource.AddFile( "content/materials/ricochet/disc_dual1.vtf" )
	resource.AddFile( "content/materials/ricochet/disc_red1.vmt" )
	resource.AddFile( "content/materials/ricochet/disc_red1.vtf" )
	resource.AddFile( "content/materials/ricochet/gradient_slow.vmt" )
	resource.AddFile( "content/materials/ricochet/gradient_slow.vtf" )
	resource.AddFile( "content/materials/ricochet/hud_edge.vmt" )
	resource.AddFile( "content/materials/ricochet/hud_edge.vtf" )
	resource.AddFile( "content/materials/ricochet/ricochet_disc/white004.vmt" )
	resource.AddFile( "content/materials/ricochet/trim_blue1.vmt" )
	resource.AddFile( "content/materials/ricochet/trim_blue1.vtf" )
	resource.AddFile( "content/materials/ricochet/trim_red.vmt" )
	resource.AddFile( "content/materials/ricochet/trim_red.vtf" )
	resource.AddFile( "content/materials/ricochet/trim_yellow.vmt" )
	resource.AddFile( "content/materials/ricochet/trim_yellow.vtf" )
	resource.AddFile( "content/materials/shadowkiller/blue.vmt" )
	resource.AddFile( "content/materials/shadowkiller/blue.vtf" )
	resource.AddFile( "content/materials/shadowkiller/GooInGlass.vmt" )
	resource.AddFile( "content/materials/shadowkiller/gooinglass.vtf" )
	resource.AddFile( "content/materials/shadowkiller/gooinglass_normal.vtf" )
	resource.AddFile( "content/materials/shadowkiller/red.vmt" )
	resource.AddFile( "content/materials/shadowkiller/red.vtf" )
	resource.AddFile( "content/materials/shadowkiller/refractsmoke.vmt" )
	resource.AddFile( "content/materials/shadowkiller/smokegrenade_normal.vtf" )
	resource.AddFile( "content/materials/shadowkiller/splode1_sheet.vmt" )
	resource.AddFile( "content/materials/shadowkiller/splode1_sheet.vtf" )
	resource.AddFile( "content/materials/skybox/sky_blackbk.vmt" )
	resource.AddFile( "content/materials/skybox/sky_blackbk.vtf" )
	resource.AddFile( "content/materials/skybox/sky_blackdn.vmt" )
	resource.AddFile( "content/materials/skybox/sky_blackdn.vtf" )
	resource.AddFile( "content/materials/skybox/sky_blackft.vmt" )
	resource.AddFile( "content/materials/skybox/sky_blackft.vtf" )
	resource.AddFile( "content/materials/skybox/sky_blacklf.vmt" )
	resource.AddFile( "content/materials/skybox/sky_blacklf.vtf" )
	resource.AddFile( "content/materials/skybox/sky_blackrt.vmt" )
	resource.AddFile( "content/materials/skybox/sky_blackrt.vtf" )
	resource.AddFile( "content/materials/skybox/sky_blackup.vmt" )
	resource.AddFile( "content/materials/skybox/sky_blackup.vtf" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_01BK.vmt" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_01BK.vtf" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_01DN.vmt" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_01DN.vtf" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_01FT.vmt" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_01FT.vtf" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_01LF.vmt" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_01LF.vtf" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_01RT.vmt" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_01RT.vtf" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_01UP.vmt" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_01UP.vtf" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_02BK.vmt" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_02BK.vtf" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_02DN.vmt" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_02DN.vtf" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_02FT.vmt" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_02FT.vtf" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_02LF.vmt" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_02LF.vtf" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_02RT.vmt" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_02RT.vtf" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_02UP.vmt" )
	resource.AddFile( "content/materials/skybox/sky_rico_space_02UP.vtf" )
	resource.AddFile( "content/materials/Sprites/bluelaser1.vmt" )
	resource.AddFile( "content/materials/Sprites/bluelaser1.vtf" )
	resource.AddFile( "content/materials/Sprites/core_beam1.vmt" )
	resource.AddFile( "content/materials/Sprites/core_beam1.vtf" )
	resource.AddFile( "content/materials/Sprites/moon1.vmt" )
	resource.AddFile( "content/materials/Sprites/moon1.vtf" )
	resource.AddFile( "content/materials/Sprites/moon2.vmt" )
	resource.AddFile( "content/materials/Sprites/moon2.vtf" )
	resource.AddFile( "content/materials/tomkranis/ktulhu.vmt" )
	resource.AddFile( "content/materials/tomkranis/ktulhu.vtf" )
	resource.AddFile( "content/materials/VGUI/logos/UI/spray_canned.vmt" )
	resource.AddFile( "content/materials/VGUI/logos/UI/spray_freeman.vmt" )
	resource.AddFile( "content/materials/VGUI/logos/UI/spray_plumbed.vmt" )
	resource.AddFile( "content/materials/VGUI/logos/UI/spray_soldier.vmt" )
	resource.AddFile( "content/models/arrow.mdl" )
	resource.AddFile( "content/models/disc.mdl" )
	resource.AddFile( "content/models/platform.mdl" )
	resource.AddFile( "content/models/platform2.mdl" )
	resource.AddFile( "content/models/platform_exhaust.mdl" )
	resource.AddFile( "content/models/powerup.mdl" )
	resource.AddFile( "content/models/props_ricochet/arrow.mdl" )
	resource.AddFile( "content/models/props_ricochet/bricks.mdl" )
	resource.AddFile( "content/models/props_ricochet/deflector.mdl" )
	resource.AddFile( "content/models/props_ricochet/deflector2.mdl" )
	resource.AddFile( "content/models/props_ricochet/platform.mdl" )
	resource.AddFile( "content/models/props_ricochet/pyramid.mdl" )
	resource.AddFile( "content/models/props_ricochet/skybox/atmosphere.mdl" )
	resource.AddFile( "content/models/props_ricochet/skybox/atmosphere_b.mdl" )
	resource.AddFile( "content/models/props_ricochet/skybox/planet.mdl" )
	resource.AddFile( "content/models/props_ricochet/skybox/rings_bk.mdl" )
	resource.AddFile( "content/models/props_ricochet/skybox/rings_ft.mdl" )
	resource.AddFile( "content/models/props_ricochet/skybox/vortex.mdl" )
	resource.AddFile( "content/models/props_ricochet/skybox/vortexlight.mdl" )
	resource.AddFile( "content/models/props_ricochet/transporter.mdl" )
	resource.AddFile( "content/models/weapon/v_disc.mdl" )
	resource.AddFile( "content/sound/ricochet/decap.wav" )
	resource.AddFile( "content/sound/ricochet/disc_fire.wav" )
	resource.AddFile( "content/sound/ricochet/disc_hit1.wav" )
	resource.AddFile( "content/sound/ricochet/disc_hit2.wav" )
	resource.AddFile( "content/sound/ricochet/powerup.wav" )
	resource.AddFile( "content/sound/ricochet/pspawn.wav" )
	resource.AddFile( "content/sound/ricochet/scream1.wav" )
	resource.AddFile( "content/sound/ricochet/scream2.wav" )
	resource.AddFile( "content/sound/ricochet/scream3.wav" )
	resource.AddFile( "content/sound/ricochet/triggerjump.wav" )
end
	
end

function GM:Initialize()
	self:AddResources()
	self:PrecacheResources()
	self:SetGlobalVars()
end

function GM:Think()
	if CurTime() >= TIMELIMIT then
		local state = self:GetGamestate()

		if state == STATE_WAITING or state == STATE_ENDING then
			self:RestartGame()
		end
	end

	ValidFunction(GAMETYPES[self:GetGametype()], "OnThink")
end

function GM:PlayerInitialSpawn(pl)
	local rawmodelname = pl:GetInfo("cl_playermodel")
	local modelname = player_manager.TranslatePlayerModel(rawmodelname)
	pl:SetModel(modelname)

	ValidFunction(GAMETYPES[self:GetGametype()], "OnPlayerInitSpawn", pl)
end

function GM:PlayerSpawn(pl)
	pl:SetWalkSpeed(150)
	pl:SetRunSpeed(150)
	pl:SetMaxSpeed(150)
	pl:SetJumpPower(0)
	pl:SetMaterial()
	pl:SetLastAttacker(nil)
	self:PlayerLoadout(pl)

	local effectdata = EffectData()
		effectdata:SetOrigin(pl:GetPos())
	util.Effect("spawneffect", effectdata, true)

	ValidFunction(GAMETYPES[self:GetGametype()], "OnPlayerSpawn", pl)
end

function GM:PlayerLoadout(pl)
	pl:Give("weapon_disc")

	ValidFunction(GAMETYPES[self:GetGametype()], "OnLoadout", pl)
end

function GM:EntityTakeDamage(pl, dmginfo)
	if dmginfo:GetAttacker() ~= pl and pl:GetLastAttacker():IsPlayer() and (pl:GetLastAttackerTime() + 3) > CurTime() then
		dmginfo:SetAttacker(pl:GetLastAttacker())
	end
end

function GM:DoPlayerDeath(pl, attacker, dmginfo)
	pl:CreateRagdoll()
	pl:AddDeaths(1)
	pl:RemoveStatus("freeze", true, true)

	local dmgtype = dmginfo:GetDamageType()
	if dmgtype == POWERUP_FIRE then
		local effectdata = EffectData()
			effectdata:SetOrigin(pl:LocalToWorld(pl:OBBCenter()))
			effectdata:SetEntity(pl)
		util.Effect("fire_death", effectdata, true)
	elseif dmgtype == POWERUP_FREEZE then
		local effectdata = EffectData()
			effectdata:SetOrigin(pl:LocalToWorld(pl:OBBCenter()))
			effectdata:SetEntity(pl)
		util.Effect("ice_death", effectdata, true)
	end

	if attacker:IsValid() and attacker:IsPlayer() and (dmginfo:GetInflictor():GetClass() == "projectile_disc" and (dmginfo:GetInflictor():GetPowerShot() or false)) then
		local effectdata = EffectData()
			effectdata:SetOrigin(pl:LocalToWorld(pl:OBBCenter()))
			effectdata:SetEntity(pl)
		util.Effect("decapitation_death", effectdata, true)
	end

	if dmginfo:GetAttacker():GetClass() == "trigger_hurt" then
		pl:EmitSound("ricochet/scream"..math.random(1,3)..".wav")
	end

	if attacker ~= pl and attacker:IsPlayer() then 
		attacker:AddFrags(1)
	end

	ValidFunction(GAMETYPES[self:GetGametype()], "OnPlayerDeath", pl, attacker)
	hook.Call("OnPlayerDeath", pl, attacker)
end

function GM:GetFallDamage(pl, speed)
	return false
end

function GM:PlayerDeathSound()
	return true
end

function GM:PlayerNoClip(pl)
	return true
end

--[[hook.Add("OnPlayerDeath", "CheckIfCall", function(...)
	MsgN(...)
end)]]
